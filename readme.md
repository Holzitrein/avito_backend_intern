#  **Тестовое задание на позицию стажёра-бэкендера**
## Запуск
```
docker compose pull
docker-compose up
```
## Реализация работы программы
- Используемая база данных: postgres
- Драйвер для работы с базой данных: pgx
- Фреймворк для REST API: gin
- Для выполнения операции с балансом, где больше одного запроса использовались транзакции
- Все приходящие данные от запросов дополнительно проходят валидацию
## Данные от базы данных
- Database name: avito
- login :        avito
- password :     avito  
## Выполненно:
- Основное задание
- Первое доп. задание
- Второе доп. задание, но на половину, не успел сделать реализацию истории пополнения балана, но база данных под это уже подготовленна и ведёт записи пополнения баланса в таблице History_add
- Функция отмены резервирования денег
- Функция перевода денег между пользвателями
## Структура проекта
```
task
│   docker-compose.yml
│   Dockerfile
│   go.mod
│   go.sum
│   readme.md
├───cmd
│   └───service_bank
│           main.go --входная точка программы
├───init
│   └───sql
│           init.sql --файл инициализации бд
└───internal
    ├───database
    │   │   database.go --функционал для работы с базой данных
    │   └───csv --папка для сгенерированных отчётов
    │           .keep
    ├───handlers
    │       handlers.go -- функционал для разрбора тела запроса 
    ├───model
    │       model.go -- файл со совсеми структурами проекта
    ├───routers
    │       routers.go -- все роуты для запросов
    └───validate
            validate.go -- валидация запросов
```
## Схема базы данных

![database](https://ltdfoto.ru/images/2022/10/26/xqChUGSfXyM.jpg "")
## **REST API**
#
**Вернуть баланс**
```
GET /user
```
- По айди пользователя возвращает его баланс
- Пример запроса в **postman**:
```
[GET] localhost:8000/user
```
```
{
    "userId": 8 //Id пользователя
}
```
- Примеры ответа:
```
{
    "balance": 0
}
```
```
{
    "balance": 250.07
}
```
```
{
    "balance": 1000
}
```
#
**Пополнить баланс**
```
POST /user
```
- По айди пользователя пополняет баланс, если же пользователя не существует, то создаёт его, также сохраняет время пополнения
- Пример запроса в **postman**:
```
[POST] localhost:8000/user
```
```
{
    "userId" : 8, //ID пользователя
    "money" : 300.76, //Количество денег к пополнению
    "note" : "From visa" //Сообщение к пополнению
}
```
- Примеры ответа:
```
{
    "status": "true"
}
```
#
**Зарезервировать деньги**
```
POST /order/create
```
- По полученным данным проверяёт есть ли такой пользователь, а также есть ли у него свободные деньги, если всё отлично, то создаёт новый заказ, а также резервирует деньги у пользователя
- Пример запроса в **postman**:
```
[POST] localhost:8000/order/create
```
```
{
    "userId" : 8,  //ID пользователя
    "idService" : 0, //ID услсуги
    "idOrder" : 5,  //ID заказа
    "price" : 1    //Стоимость заказа
}
```
- Примеры ответа:
```
{
    "status": "Successfully"
}
```
```
{
    "status": "User not found"
}
```
```
{
    "status": "not enough money"
}
```
#
**Списать деньги или отменить резервацию денег**
```
POST /order
```
- По полученным данным проверяёт есть ли такой заказ(Сверяет все поля! если условно вести стоимость иную, такого заказа не найдёт), также проверяет, что такой заказ ещё имеет статус резерва, после в зависимости от запроса списывает деньги или отменяет заказ
- Пример запроса в **postman**:
```
[POST] localhost:8000/order
```
```
{
    "userId" : 8, // ID пользователя
    "idService" : 0, // ID услуги
    "idOrder" : 5, // ID заказа
    "price" : 1,  //Стоимость заказа
    "cmd" : "approved" //Команда на списание денег
}
```
```
[POST] localhost:8000/order
```
```
{
    "userId" : 8,
    "idService" : 0,
    "idOrder" : 5,
    "price" : 1,
    "cmd" : "cancel" //Команда на отмену заказа
}
```
- Примеры ответа:
```
{
    "status": "Successfully"
}
```
```
{
    ""status": "Order not found"
}
```
#
**Перевод денег от одного пользователя другому**
```
POST /user/transfer
```
- По полученным данным проверяет существуют ли такие пользователи, а также хватает ли денег и не в резерве ли они у первого пользователя, после чего осуществляет транзакцию
- Пример запроса в **postman**:
```
[POST] localhost:8000/user/transfer
```
```
{
    "userId": 8, // ID пользователя, у которого списывают деньги
    "userId2" : 2, // ID пользователя, которому перводят деньги
    "money" : 50 // Сумма перевода
}
```
- Примеры ответа:
```
{
    "status": "Successfully"
}
```
```
{
    "status": "User not found"
}
```
```
{
    "status": "not enough money"
}
```
#
**Получение ссылки на csv файла отчёта по услугам**
```
GET /service
```
- запрашивает список всех услуг, после чего проверяет по указанному месяцу прибыль по каждой, генерирует csv файл на сервере и возвращает ссылку на файл
- Пример запроса в **postman**:
```
[GET] localhost:8000/service
```
```
{
    "date" : "2022-10" // месяц за который необходим отчёт
}
```
- Пример ответа:
```
{
    "url": "localhost:8000/csv/report_2022-10.csv"
}
```
#
**Получение файла по ссылке**
```
GET /csv/{file}
```
- запрашивает список всех услуг, после чего проверяет по указанному месяцу прибыль по каждой, генерирует csv файл на сервере и возвращает ссылку на файл
- Пример запроса в **postman**:
```
[GET] localhost:8000/csv/report_2022-10.csv
```
```
{
    "date" : "2022-10" // месяц за который необходим отчёт
}
```
- Пример ответа:
```
report_2022-10.csv
Услуга,Доход
Услуга №1,0
Услуга №2,0
Услуга №3,100000
```
#
**Получение истории списывания денег пользователя с пагинацией и сортировкой**
```
GET /user/history
```
- по указаному Id пользователся, методу сортировки, номеру страницы, а также количество строк на одной странице возвращает массив списаний 
- Пример запроса в **postman**:
```
[GET] localhost:8000/user/history
```
```
{
    "iduser" : 8, // ID пользователя
    "page" : 3,  //Номер запрашиваемой страницы
    "rows" : 3,  //Количество операций на одной странице
    "sort" : "price_up" // Метод сортировки, также существует такие методы как:
    // "price_down", "created_up", "created_down"
}
```
- Пример ответа:
```
{
    "Orders": null
}
```
```
{
    "Orders": [
        {
            "time": "2022-10-26 17:26:30.452574 +0000 UTC",
            "money": 10,
            "service": "Услуга №3"
        },
        {
            "time": "2022-10-26 17:26:49.719676 +0000 UTC",
            "money": 30,
            "service": "Услуга №3"
        },
        {
            "time": "2022-10-26 17:20:37.254647 +0000 UTC",
            "money": 100000,
            "service": "Услуга №3"
        }
    ]
}
```
#